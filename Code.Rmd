---
title: "Survival Analysis Final Project"
author: Group 10
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(janitor)
library(ggcorrplot)
library(dplyr)
library(gtsummary)
library(tidyr)
library(ggplot2)
```

## EDA

### Load the dataset and clean column names

```{r}
file_path <- "Breast Cancer METABRIC.csv"

data <- read.csv(file_path, na.strings = "") %>%  # Treat blank strings as NA
  clean_names() %>%
  filter(cancer_type != "Breast Sarcoma") %>%  # only 3 patients are not Breast Cancer, exclude them
  rename(
    vital_status = patient_s_vital_status,
    three_gene_classifier_subtype = x3_gene_classifier_subtype
  ) %>%
  # Exclude patients with both overall_survival_months and overall_survival_status missing
  filter(!(is.na(overall_survival_months) & is.na(overall_survival_status)))

# View the cleaned data
head(data)
```

Our primary objective in this project is to investigate factors associated with overall survival (OS) in the METABRIC breast cancer cohort. Specifically, we define overall survival as the time from diagnosis to death from any cause, with overall_survival_months providing the follow-up time and overall_survival_status indicating whether the death event occurred.

For the survival analysis, both a valid survival time and an event indicator are required for each patient. In this dataset, some patients have overall_survival_months and overall_survival_status missing simultaneously, meaning that no follow-up or outcome information is available for these individuals. These cases are not censored observations but instead represent completely missing survival data. Therefore, we excluded patients with both overall_survival_months and overall_survival_status missing, so that the analysis dataset contains only patients with interpretable OS information for time-to-event modelling.

```{r}
dim(data)            # number of rows and columns
colnames(data)       # check all variable names
```

### Visualization of Overall Survival (OS)

```{r warning=FALSE}
ggplot(data, aes(x = overall_survival_months)) +
geom_histogram(bins = 20, color = "black", fill = "skyblue") +
labs(
title = "Distribution of Overall Survival Time",
x = "Overall survival time (months)",
y = "Count"
) +
theme_minimal()
```

```{r warning=FALSE}
ggplot(data, aes(x = factor(overall_survival_status))) +
  geom_bar(aes(y = ..count..), fill = "skyblue", color = "black") +  # Count bars
  geom_text(
    stat = "count",
    aes(label = paste0(..count.., " (", round(..count.. / sum(..count..) * 100, 1), "%)")),
    vjust = -0.3,      # move labels slightly above the bar
    color = "black",
    size = 4
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.1))  # add 10% headroom on top so labels are fully visible
  ) +
  labs(
    title = "Distribution of Overall Survival Status",
    x = "Overall Survival Status",
    y = "Count"
  ) +
  theme_minimal()
```

### Check for missing values:

```{r}
# Proportion and count of missing values per variable (only variables with missing values)
missing_summary <- data %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%  # count missing values
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "missing_count"
  ) %>%
  mutate(
    prop_missing = missing_count / nrow(data)  # calculate proportion of missing values
  ) %>%     # keep only variables with any missing values
  arrange(desc(missing_count))       # sort by missing count (descending)

missing_summary
```

```{r}
# Plot missing values per variable (count)
ggplot(missing_summary, aes(x = reorder(variable, missing_count), y = missing_count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Missing Values in Columns",
    x = "Variable",
    y = "Number of Missing Rows",
    caption = "Data: METABRIC Breast Cancer Study"
  ) +
  theme_minimal() +
  coord_flip()  # Flip the chart for better readability
```

### Define continuous and categorical variables manually:

#### Continuous variables:

```{r}
continuous_vars <- c(
  "age_at_diagnosis",
  "tumor_size",
  "lymph_nodes_examined_positive",
  "mutation_count",
  "overall_survival_months",
  "relapse_free_status_months"
)

continuous_vars
```

```{r warning=FALSE}
data_plot <- data %>%
  mutate(
    log_tumor_size = log(tumor_size),
    log_mutation_count = log(mutation_count),
    log_lymph_nodes_examined_positive = log(lymph_nodes_examined_positive+1)
  )

# variables you want to plot (original + new logs)
vars_to_plot <- c(
  setdiff(continuous_vars, "overall_survival_months"),    # original ones
  "log_tumor_size",
  "log_mutation_count",
  "log_lymph_nodes_examined_positive"
)

# ---- PLOT ------------------------------------------------------------------

data_plot %>%
  select(all_of(vars_to_plot)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ variable, scales = "free_x") +
  labs(
    title = "Distributions of Continuous and Log-Transformed Variables",
    x = "Value",
    y = "Count"
  )
```

#### Categorical variables:

```{r}
# Treat other variables as categorical for EDA, but exclude patient_id
categorical_vars <- setdiff(names(data), c(continuous_vars, "patient_id"))
```

```{r}
# Frequency and proportion for each categorical variable (excluding overall_survival_status)
for (var in setdiff(categorical_vars, "overall_survival_status")) {
  cat("\n\n==============================\n")
  cat("Variable:", var, "\n")
  
  tmp <- data %>%
    count(.data[[var]]) %>%                 # count each level
    mutate(prop = n / sum(n)) %>%           # proportion within the variable
    arrange(desc(n))                        # sort by frequency
  
  print(tmp)                 # print all rows for this variable
}  
```

sex and cancer_type have only a single category (Female and Breast Cancer) in this dataset, making them uninformative for the survival analysis model, as they do not provide any variation in the data.

```{r}
# Remove 'sex' and 'cancer_type' from categorical_vars
categorical_vars <- setdiff(categorical_vars, c("sex", "cancer_type"))

# Print updated categorical_vars
categorical_vars
```

```{r}
cats_for_plot <- c(
  "type_of_breast_surgery",
  "cancer_type_detailed",
  "cellularity",
  "chemotherapy",
  "her2_status",
  "hormone_therapy",
  "radio_therapy",
  "inferred_menopausal_state"
)

cat_long <- data %>%
  select(all_of(cats_for_plot)) %>%
  pivot_longer(
    cols = everything(),
    names_to  = "variable",
    values_to = "category"
  ) %>%
  drop_na(category) %>%
  # order levels within each variable by frequency
  group_by(variable) %>%
  mutate(category = fct_infreq(category)) %>%
  ungroup()

ggplot(cat_long, aes(x = category)) +
  geom_bar() +
  coord_flip() +  # make bars horizontal so labels are readable
  facet_wrap(~ variable, scales = "free_y", ncol = 2) +
  labs(
    title = "Counts for Key Categorical Variables",
    x = NULL,
    y = "Count"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 8),
    strip.text  = element_text(face = "bold")
  )
```


### Correlation analysis:

```{r warning=FALSE}
# Calculate correlation matrix for continuous variables
cor_matrix <- data %>%
  select(all_of(continuous_vars)) %>%
  cor(use = "pairwise.complete.obs")  # handle NA values by pairwise complete observation

ggcorrplot(cor_matrix, 
           type = "upper",        # Show only the lower triangle of the matrix
           lab = TRUE,            # Display correlation values
           colors = c("blue", "white", "red"),  # Color gradient
           title = "Correlation Matrix of Continuous Variables")
```

Based on the correlation matrix shown, relapse_free_status_months and overall_survival_months exhibit a very strong positive correlation of 0.9, indicating that these two variables are highly related. However, other continuous variables, such as nottingham_prognostic_index, mutation_count, lymph_nodes_examined_positive, and tumor_size, do not show high correlations with each other.

If we are conducting survival analysis with overall_survival_status as the event indicator, we should exclude relapse_free_status_months as a predictor in the model, as it is strongly correlated with overall_survival_months. Including both would lead to multicollinearity, where these two variables would essentially provide redundant information, making it difficult to assess their independent effects on survival. Therefore, we should choose overall_survival_months as the time variable, as it directly represents the total survival time and includes all relevant information related to the occurrence of the event.

```{r}
# Remove 'relapse_free_status_months' from continuous_vars
continuous_vars <- setdiff(continuous_vars, "relapse_free_status_months")
```

```{r warning=FALSE}
# Create an empty data frame to store results
chi_results <- data.frame(
  variable = character(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)

# Perform Chi-Square Test for each categorical variable with overall_survival_status
for (var in categorical_vars) {
  
  # Create a contingency table for each variable and survival status
  contingency_table <- table(data[[var]], data$overall_survival_status)
  
  # Perform Chi-Square test
  chi_test <- chisq.test(contingency_table)
  
  # Store the results in chi_results dataframe
  chi_results <- rbind(chi_results, data.frame(variable = var, p_value = chi_test$p.value))
  
  # Print the contingency table and the p-value
  cat("\n\n==============================\n")
  cat("Variable:", var, "\n")
  print(contingency_table)
  cat("P-value for Chi-Square Test:", chi_test$p.value, "\n")
}

# Print the final results with p-values for all variables except overall_survival_status
chi_results
```

Since "vital_status" variable is already directly related to the outcome of survival and is a proxy for the status of the patient, it is unnecessary to include it in the model. This variable is highly correlated with survival, and adding it could lead to perfect prediction of the outcome or multicollinearity.

Although the chi-square test showed a statistically significant association between "cohort" and overall survival status, we decided not to include "cohort" as a covariate in the survival model. In this dataset, "cohort" primarily reflects study batch or recruitment group rather than a meaningful clinical or biological characteristic of the patients. Therefore, it is better interpreted as a design-related or administrative label, rather than a true risk factor for overall survival.

Although "relapse_free_status" shows a highly significant association with overall survival status in the chi-square test, we chose not to include it as a covariate in the overall survival model. Clinically, relapse is an intermediate outcome that occurs after baseline and lies on the causal pathway between baseline risk factors and death. Treating relapse status as a predictor of overall survival would therefore introduce information leakage and could distort the estimated effects of true baseline covariates. In addition, "relapse_free_status" is closely related to "relapse_free_status_months", which we already excluded as an alternative time-to-event endpoint.

```{r}
# Filter results to only show variables with p-value < 0.05 and exclude 'vital_status' and 'cohort'
significant_vars <- chi_results %>%
  filter(p_value < 0.05) %>%
  filter(!variable %in% c("vital_status","cohort","relapse_free_status"))

# Print the significant variables
significant_vars
```

### Final dataset after variable selection

```{r}
# Extract significant variables' names from significant_vars (filter for p-value < 0.05)
significant_var_names <- significant_vars$variable

# Filter the data by including only the selected variables from both significant_vars and continuous_vars
selected_vars <- c(significant_var_names, continuous_vars)

# Create a new dataset with only the selected variables
filtered_data <- data %>%
  select(all_of(selected_vars))

# View the filtered dataset
head(filtered_data)
```

### Overview of demographic and baseline variables (Table 1)

```{r}
filtered_data <- filtered_data |>
  mutate(overall_survival_status = factor(overall_survival_status))

vars_for_table1 <- c(
  "age_at_diagnosis",
  "her2_status",
  "tumor_size",
  "lymph_nodes_examined_positive",
  "mutation_count",
  "nottingham_prognostic_index",
  "type_of_breast_surgery",
  "cancer_type_detailed",
  "pam50_claudin_low_subtype",
  "neoplasm_histologic_grade",
  "tumor_other_histologic_subtype",
  "inferred_menopausal_state",
  "integrative_cluster",
  "radio_therapy",
  "three_gene_classifier_subtype",
  "tumor_stage"
)

continuous_vars <- c(
  "age_at_diagnosis",
  "tumor_size",
  "lymph_nodes_examined_positive",
  "mutation_count",
  "nottingham_prognostic_index"
)
categorical_vars <- setdiff(vars_for_table1, continuous_vars)

pvalue_fmt <- function(x) {
  ifelse(x < 0.001, "<0.001", formatC(x, format = "f", digits = 3))
}

table1 <-
  data |>
  dplyr::select(all_of(c("overall_survival_status", vars_for_table1))) |>
  tbl_summary(
    by = overall_survival_status,
    type = list(
      all_of(continuous_vars)  ~ "continuous2",
      all_of(categorical_vars) ~ "categorical"
    ),
    statistic = list(
      all_of(continuous_vars) ~ "{mean} ({sd})",
      all_categorical()       ~ "{n} ({p}%)"
    ),
    missing = "no"   # <--- do NOT create 'Unknown' rows
  ) |>
  add_n() |>
  add_p(
    test = list(
      all_of(continuous_vars)  ~ "t.test",
      all_categorical()        ~ "chisq.test"
    ),
    pvalue_fun = pvalue_fmt
  ) |>
  modify_caption("**Table 1. Baseline characteristics by overall survival status**") |>
  bold_labels()

table1
```


### Multivariable Cox Model

```{r}
library(survival)
library(broom)

final_inter_mod <- coxph(
  Surv(
    overall_survival_months,
    overall_survival_status == "Deceased"   # event indicator
  ) ~ 
    age_at_diagnosis +
    tumor_size +
    lymph_nodes_examined_positive +
    nottingham_prognostic_index +
    radio_therapy +
    inferred_menopausal_state +
    tumor_stage +
    three_gene_classifier_subtype +
    type_of_breast_surgery +
    cancer_type_detailed +
    pam50_claudin_low_subtype +
    tumor_other_histologic_subtype +
    integrative_cluster +
    mutation_count +
    radio_therapy:tumor_size, # treatment × tumor size interaction
  data = filtered_data
)

summary(final_inter_mod)

cox_tidy <- broom::tidy(
  final_inter_mod,
  exponentiate = TRUE,
  conf.int     = TRUE
)

cox_tidy
```

The multivariable Cox proportional hazards model evaluates how demographic, tumor, and treatment characteristics jointly affect overall survival among METABRIC breast cancer patients. After adjustment for all covariates, traditional prognostic factors such as older age at diagnosis, larger tumor size, a higher number of positive lymph nodes, and a higher Nottingham prognostic index generally show associations compatible with increased hazard of death, indicating worse survival as these measures of disease burden increase.

Tumor-related categorical variables, including tumor stage, three_gene_classifier_subtype (ER/HER2 profile), pam50_claudin_low_subtype, tumor_other_histologic_subtype, cancer_type_detailed, and integrative_cluster, capture biologic and histologic differences between tumors and contribute additional information on risk. Treatment variables such as radio_therapy, along with menopausal status and type_of_breast_surgery, help describe differences in management patterns and their impact on survival. The inclusion of a radio_therapy × tumor_size interaction allows the association between tumor size and mortality risk to differ between patients who did and did not receive radiotherapy.

Hazard ratios from this model represent the multiplicative change in the instantaneous risk of death associated with each covariate, holding all others constant. The directions of effect are broadly consistent with clinical expectations; however, these interpretations rely on the proportional hazards assumption, which is examined in the next section.

### Proportional hazards (PH) diagnostics

```{r}
# Residual diagnostics
par(mfrow = c(2, 2))

plot(
  resid(final_inter_mod, type = "martingale"),
  main = "Martingale Residuals vs Linear Predictor",
  ylab = "Martingale Residuals"
)
abline(h = 0, lty = 2)

plot(
  resid(final_inter_mod, type = "deviance"),
  main = "Deviance Residuals vs Linear Predictor",
  ylab = "Deviance Residuals"
)
abline(h = 0, lty = 2)

# Schoenfeld residual PH test
ph_test <- cox.zph(final_inter_mod)
ph_test

# Schoenfeld residual plots
par(mfrow = c(2, 2))
plot(ph_test)
abline(h = 0, lty = 2)
par(mfrow = c(1, 1))

```
Martingale and deviance residual plots do not reveal severe global model misfit, although a small number of influential observations and mild departures from perfect linearity are apparent. These diagnostics mainly suggest that the overall functional form of the model is reasonable but not flawless.

The Schoenfeld residual test provides a more direct assessment of the proportional hazards assumption. The global test, along with several covariate-specific tests, indicates statistically significant time-varying effects for some predictors. In particular, variables such as age_at_diagnosis, radiotherapy, tumor characteristics, and their interaction (radio_therapy × tumor_size) show patterns in their Schoenfeld residual plots that deviate from a flat horizontal line, suggesting that their effects on the hazard of death change over time rather than remaining constant.

Because the proportional hazards assumption is a key requirement of the Cox model, these findings imply that hazard ratios should be interpreted with some caution. To investigate robustness under an alternative modeling framework that does not require proportional hazards, we fit accelerated failure time (AFT) models as a sensitivity analysis.

### AFT sensitivity analysis

```{r}
aft_weibull <- survreg(
  Surv(
    overall_survival_months,
    overall_survival_status == "Deceased"
  ) ~ 
    age_at_diagnosis +
    tumor_size +
    lymph_nodes_examined_positive +
    nottingham_prognostic_index +
    radio_therapy +
    inferred_menopausal_state +
    tumor_stage +
    three_gene_classifier_subtype +
    type_of_breast_surgery +
    cancer_type_detailed +
    pam50_claudin_low_subtype +
    tumor_other_histologic_subtype +
    integrative_cluster +
    mutation_count +
    log(tumor_size):radio_therapy +
    age_at_diagnosis:radio_therapy,
  data = filtered_data,
  dist = "weibull"
)

# Compare alternative distributions
aft_lognormal   <- update(aft_weibull, dist = "lognormal")
aft_loglogistic <- update(aft_weibull, dist = "loglogistic")

AIC(aft_lognormal)
AIC(aft_weibull)
AIC(aft_loglogistic)

# Extract time ratios with confidence intervals for Weibull model
aft_ci <- exp(confint(aft_weibull))
aft_tr <- exp(coef(aft_weibull))

aft_table <- data.frame(
  Variable   = names(aft_tr),
  Time_Ratio = aft_tr,
  CI_Lower   = aft_ci[, 1],
  CI_Upper   = aft_ci[, 2]
)

aft_table
```

Given the evidence of proportional hazards violations in the Cox model, we fitted accelerated failure time (AFT) models as a robustness check. AFT models describe how covariates multiply survival time directly, rather than affecting the hazard, and therefore do not require proportional hazards.

Using the same core predictors as in the Cox model, along with interactions involving log-transformed tumor_size and radiotherapy and age_at_diagnosis with radiotherapy, we fitted Weibull, lognormal, and log-logistic AFT models. Comparison of AIC values identified the Weibull distribution as the best-fitting parametric form among the three candidate models.

In the AFT framework, exponentiated coefficients are interpreted as time ratios: a time_ratio greater than 1 indicates longer expected survival, whereas a time_ratio less than 1 indicates shorter expected survival, holding other factors constant. Consistent with the Cox model, factors reflecting greater tumor burden or worse prognosis (e.g., larger tumor_size, more lymph_nodes_examined_positive, higher nottingham_prognostic_index, and more advanced tumor_stage) are associated with shorter survival times. The general agreement between the Cox and Weibull AFT results suggests that the main substantive conclusions about key prognostic factors are robust, even when relaxing the proportional hazards assumption.

