---
title: "Model_Code"
output: html_document
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidyr)
library(readr)
library(MASS)
library(survival)
```
 
```{r message=FALSE, warning=TRUE} 

data= read_csv("Breast Cancer METABRIC.csv") |>
  janitor::clean_names() |>
  filter(cancer_type != "Breast Sarcoma") |> # only 3 patients are not Breast Cancer, exclude them
  rename(
     vital_status = patients_vital_status,
     three_gene_classifier_subtype = x3_gene_classifier_subtype
  )|> 
  mutate(cellularity = factor(cellularity, levels = c("Low","Medium","High")),
         chemotherapy = factor(chemotherapy, levels = c("No","Yes")),
         overall_survival_status = ifelse(overall_survival_status=="Living", 0, 1), 
         her2_status= factor( her2_status, levels = c("Negative","Positive"),
                             labels = c("Negative","Positive")), 
         hormone_therapy = factor(hormone_therapy, levels = c("No","Yes"),
                                  labels = c("No","Yes")),
         inferred_menopausal_state= factor(inferred_menopausal_state,
                                           levels = c("Pre", "Post"), labels = c("Pre","Post")), 
         primary_tumor_laterality= factor(primary_tumor_laterality,
                                          levels = c("Left","Right"), labels = c("Left","Right")),
         radio_therapy = factor(radio_therapy,
                                levels=c("No","Yes"),  labels = c("No","Yes"))
         
         )
```



# Model building 

## Stepwise variable selection 

Do we want to consider any interaction terms? time variant variables?

Based on EDA, we will exclude relapse free time and vital status since it was highly correlated with the outcome. It will also exclude sex and type of cancer since this data only include female breast cancer patients. 

Will see if backward selection retains cohort.

```{r message=FALSE, warning=FALSE, include=FALSE}
#complete data
data1= data[complete.cases(data),]

full_model = coxph( Surv(overall_survival_months, overall_survival_status) ~ 
    age_at_diagnosis + type_of_breast_surgery + 
    cancer_type_detailed +  cellularity +   chemotherapy +   pam50_claudin_low_subtype + cohort
    + er_status_measured_by_ihc + er_status +  neoplasm_histologic_grade +
    her2_status_measured_by_snp6 + her2_status +   tumor_other_histologic_subtype +
    hormone_therapy + inferred_menopausal_state +  integrative_cluster +
    primary_tumor_laterality + lymph_nodes_examined_positive +
    mutation_count + nottingham_prognostic_index +  oncotree_code + pr_status +
    radio_therapy +   three_gene_classifier_subtype + tumor_size +  tumor_stage,
    data= data1)

backward_model = step(full_model, direction = "backward")    
summary(backward_model)
```

```{r message=TRUE, warning=TRUE, include=FALSE}
model.1= coxph(Surv(overall_survival_months, overall_survival_status ) ~ age_at_diagnosis + her2_status + hormone_therapy + inferred_menopausal_state + primary_tumor_laterality + lymph_nodes_examined_positive + nottingham_prognostic_index + radio_therapy + tumor_size , 
               data=data)

forward_model = stepAIC(model.1, direction = "forward")
```


```{r} 
full_inter_mod= coxph(Surv(overall_survival_months, overall_survival_status ) ~   
                        age_at_diagnosis + her2_status + hormone_therapy + 
                        inferred_menopausal_state + primary_tumor_laterality +
                        lymph_nodes_examined_positive + nottingham_prognostic_index +
                        radio_therapy + tumor_size + 
                        tumor_size:hormone_therapy + age_at_diagnosis:radio_therapy , 
                      data=data1) 

final_inter_mod= step(full_inter_mod, direction = "backward")
```
 


Check the diagnotic plots from class and test them here. age, her2 status, infered+menopausal_state and horomone_therapy:turmo_size may violate PH assumption

# Model Diagnostic Plots 

### Residual Plots
```{r} 
#Martingale Residuals 
res_mart= residuals(final_inter_mod, type = "martingale")
vars =  c("age_at_diagnosis",
          "lymph_nodes_examined_positive",
          "nottingham_prognostic_index", "tumor_size")
pred_lp = predict(final_inter_mod, type = "lp")

 plot(
  pred_lp, res_mart,
  xlab = "Predicted Linear Predictor",
  ylab = "Martingale Residuals",
  main = "Martingale Residuals vs Linear Predictor"
)
abline(h = 0, col = "red")
  

par(mfrow = c(2,2))

for (v in vars) {
  plot(
    data1[[v]], res_mart,
    xlab = v,
    ylab = "Martingale Residuals",
    main = paste("Martingale Residuals vs", v)
  )
  abline(h = 0, col = "red")
  lines(lowess(data1[[v]], res_mart), lwd = 2)
}
 

```

The Martingale residuals vs. predicted values appear to violate the linearity assumption. The individual plots show there is information which is not caotured by the model which needs to be addressed. Example: The larger notingham prognostic index the larger the residuals. 

```{r}
#Deviance residuals 

res_dev= residuals(final_inter_mod, type = "deviance")
par(mfrow = c(1,2))

plot(
  pred_lp, res_dev,
  xlab = "Predicted Linear Predictor",
  ylab = "Deviance Residuals",
  main = "Deviance Residuals vs Linear Predictor"
)
abline(h = 0, col = "red")
par(mfrow = c(1,1))


par(mfrow = c(2,2))
for (v in vars) {
  plot(
    data1[[v]], res_dev,
    xlab = v,
    ylab = "Deviance Residuals",
    main = paste("Deviance Residuals vs", v)
  )
  abline(h = 0, col = "red")
  lines(lowess(data1[[v]], res_dev), lwd = 2)
}
```

The deviance residual plots show indication of non-constant covariates as shown in the Martingale residual plots.


```{r}
# Schoenfeld residuals 

cox.zph(final_inter_mod)

par(mfrow = c(2,2))
plot(cox.zph(final_inter_mod))+
  abline(h = 0, col = "red")
```

The weighted Schoenfeld Residuals show some covariates vary by time which confirms there lacks proportionality across time. 
 


The weighted Schoenfeld Residuals show some covariates vary by time which confirms there lacks proportionality across time. 




# Addressing PH assumption Violations

(Do we also want to consider peicewise cox model? or other paramteric survival models using expo~?)

### Stratification

```{r}
strat_mod = coxph(Surv(overall_survival_months, overall_survival_status ) ~   
                        age_at_diagnosis + her2_status + strata(hormone_therapy) + 
                        inferred_menopausal_state + primary_tumor_laterality +
                        lymph_nodes_examined_positive + nottingham_prognostic_index +
                        radio_therapy + tumor_size + 
                        tumor_size:hormone_therapy + age_at_diagnosis:radio_therapy +
                     age_at_diagnosis:her2_status:lymph_nodes_examined_positive, 
                      data=data1) 
summary(strat_mod) 
```

Stratification did not address the violations to PH assumptions, so will now consider time varying coeffcients. 



### Time varying covariate coefficient

Checking time variant coefficients for continuous predictors with violations:

- age  
- inferred_menoposaul_state
- nottingham_prognostic_index
- hormone_therapy::tumor_size

```{r}
tmv_mod =coxph(
  Surv(overall_survival_months, overall_survival_status) ~  age_at_diagnosis + 
    her2_status +  hormone_therapy + inferred_menopausal_state +
    primary_tumor_laterality +   lymph_nodes_examined_positive +  nottingham_prognostic_index +
    radio_therapy + tumor_size +   tumor_size:hormone_therapy + age_at_diagnosis:radio_therapy +
    age_at_diagnosis:her2_status:lymph_nodes_examined_positive +
    tt(age_at_diagnosis) + tt(lymph_nodes_examined_positive) + tt(nottingham_prognostic_index),
  data = data1, 
  tt = function(x, t, ...) {
    x * log(t) })

summary(tmv_mod)
```

```{r}
AIC(final_inter_mod)
AIC(tmv_mod)
```

The time varying coefficient model did lower AIC suggesting slight improvement in the model. 

#### Re-check residuals 

```{r}
 #  Martingale Residuals 
res_mart= residuals(tmv_mod, type = "martingale")

vars = c("age_at_diagnosis",
          "lymph_nodes_examined_positive",
          "nottingham_prognostic_index",
          "tumor_size")
 
pred_lp=  predict(tmv_mod, type = "lp")

# Residuals vs LP
plot( pred_lp, res_mart,
  xlab = "Predicted Linear Predictor",
  ylab = "Martingale Residuals",
  main = "Martingale Residuals vs Linear Predictor (Time-Varying Model)")
abline(h = 0, col = "red")

# Residuals vs Covariates
par(mfrow = c(2,2))
for (v in vars) {
  plot(
    model.frame(tmv_mod)[[v]], res_mart,
    xlab = v,
    ylab = "Martingale Residuals",
    main = paste("Martingale Residuals vs", v, "(TVC Model)")
  )
  abline(h = 0, col = "red")
  lines(lowess( model.frame(tmv_mod)[[v]], res_mart), lwd = 2)
}
par(mfrow = c(1,1))



```

The individual plots for predictors show all surrounding zero. The nottingham_prognostic_index may be tested with a spline to check if there is sig. non-linearity left. There are some very large tumor sizes while others are smaller, so we may want to redo process with log_tumor_size instead. Other than that there are no significant non-linear trends that we need to account for.

**change tt(log(tumor_size)) it results in slightly small AIC maybe since it reduces the influence of large outlier tumor size**


```{r}
#Deviance residuals 
res_dev= residuals(tmv_mod, type = "deviance")
par(mfrow = c(1,2))
 

plot( pred_lp, res_dev,
  xlab = "Predicted Linear Predictor",
  ylab = "Deviance Residuals",
  main = "Deviance Residuals vs Linear Predictor" )
abline(h = 0, col = "red")
par(mfrow = c(1,1))


par(mfrow = c(2,2))
for (v in vars) {
  plot(
    model.frame(tmv_mod)[[v]], res_dev,
    xlab = v,
    ylab = "Deviance Residuals",
    main = paste("Deviance Residuals vs", v)
  )
  abline(h = 0, col = "red")
  lines(lowess(model.frame(tmv_mod)[[v]], res_dev), lwd = 2)
}
```
The deviance plots show The residuals are mostly centered around zero, which indicates no  misfit of the overall model, but there are a few larger positive residuals.

**Can also consider removing outliers to check if it changes significantly**

**If this doesn't fix the issues then try AFT model or expo regression or weibull regression model**



### Re-check model fit

(Comparison with km estimates, cumulative hazard vs time plots, AIC comparison)


